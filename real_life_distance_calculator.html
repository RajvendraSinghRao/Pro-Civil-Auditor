<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Distance Measurement</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9f9f9;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    color: #333;
  }
  h1 {
    margin-bottom: 10px;
    color: #2c3e50;
    text-align: center;
  }
  input[type="file"] {
    display: none;
  }
  label {
    background-color: #2c3e50;
    color: #fff;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin-bottom: 10px;
  }
  canvas {
    border: 2px solid #2c3e50;
    border-radius: 10px;
    margin-top: 10px;
    width: 90%;
    max-width: 640px;
    touch-action: none;
  }
  #controls {
    margin-top: 15px;
  }
  button {
    background-color: #2c3e50;
    color: #fff;
    border: none;
    padding: 10px 20px;
    margin: 5px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
  }
  button:hover {
    background-color: #34495e;
  }
  #info {
    margin-top: 15px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    white-space: pre-line;
  }
</style>
</head>
<body>

<h1>Distance Measurement</h1>

<label for="imageInput">Select Image from Gallery</label>
<input type="file" id="imageInput" accept="image/*">

<canvas id="canvas"></canvas>

<div id="controls">
  <button id="undoBtn">Undo Last Point</button>
  <button id="calculateBtn">Calculate Distance</button>
</div>

<div id="info">Select an image to start.</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const imageInput = document.getElementById('imageInput');
const undoBtn = document.getElementById('undoBtn');
const calculateBtn = document.getElementById('calculateBtn');
const info = document.getElementById('info');

let img = new Image();
let points = [];
let realWidth = 0;
const FOCAL_LENGTH = 700; // approximate

// Load image from gallery
imageInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    img.src = event.target.result;
  }
  reader.readAsDataURL(file);
});

// Draw image when loaded
img.onload = function() {
  canvas.width = img.width;
  canvas.height = img.height;
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  points = [];
  info.innerText = "Tap top-left and bottom-right points to create rectangle.";
  realWidth = parseFloat(prompt("Enter real-world width of the object in cm:"));
  if (isNaN(realWidth) || realWidth <= 0) {
    info.innerText = "Invalid width. Reload page to try again.";
  }
}

// Handle touch to select points
canvas.addEventListener('touchstart', (e) => {
  if (!img.src) return;

  const rect = canvas.getBoundingClientRect();
  const touch = e.touches[0];
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const x = (touch.clientX - rect.left) * scaleX;
  const y = (touch.clientY - rect.top) * scaleY;

  points.push({x, y});
  redraw();

  e.preventDefault();
}, { passive: false });

// Undo last point
undoBtn.addEventListener('click', () => {
  if (points.length > 0) {
    points.pop();
    redraw();
  }
});

// Calculate distance
calculateBtn.addEventListener('click', () => {
  if (points.length < 2 || !realWidth) {
    info.innerText = "Select two points and enter object width first.";
    return;
  }
  const widthPx = Math.abs(points[1].x - points[0].x);
  const distanceCm = (realWidth * FOCAL_LENGTH) / widthPx;
  const distanceMeters = distanceCm / 100;
  const distanceFeet = distanceCm / 30.48;
  info.innerText = `Distance:\n${distanceCm.toFixed(2)} cm | ${distanceMeters.toFixed(2)} m | ${distanceFeet.toFixed(2)} ft`;
});

// Redraw canvas with image, points, and rectangle
function redraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  // Draw points as dots
  ctx.fillStyle = 'red';
  points.forEach(p => {
    ctx.beginPath();
    ctx.arc(p.x, p.y, 6, 0, 2*Math.PI);
    ctx.fill();
  });

  // Draw rectangle if two points
  if (points.length === 2) {
    const width = points[1].x - points[0].x;
    const height = points[1].y - points[0].y;
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 3;
    ctx.strokeRect(points[0].x, points[0].y, width, height);
  }
}
</script>

</body>
</html>
