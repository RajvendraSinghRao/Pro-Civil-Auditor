<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Distance Measurement</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #f9f9f9;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  color: #333;
}
h1 { color: #2c3e50; text-align: center; }
input[type="file"] { display: none; }
label {
  background-color: #2c3e50;
  color: #fff;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  margin-bottom: 10px;
}
canvas {
  border: 2px solid #2c3e50;
  border-radius: 10px;
  margin-top: 10px;
  width: 90%;
  max-width: 640px;
  touch-action: none;
}
#controls { margin-top: 15px; }
button {
  background-color: #2c3e50;
  color: #fff;
  border: none;
  padding: 10px 20px;
  margin: 5px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
}
button:hover { background-color: #34495e; }
#info {
  margin-top: 15px;
  font-size: 18px;
  font-weight: bold;
  text-align: center;
  white-space: pre-line;
}
</style>
</head>
<body>

<h1>Distance Measurement</h1>

<label for="imageInput">Select Image from Gallery</label>
<input type="file" id="imageInput" accept="image/*">

<canvas id="canvas"></canvas>

<div id="controls">
  <button id="undoBtn">Undo Rectangle</button>
  <button id="calculateBtn">Calculate Distance</button>
</div>

<div id="info">Select an image to start.</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const imageInput = document.getElementById('imageInput');
const undoBtn = document.getElementById('undoBtn');
const calculateBtn = document.getElementById('calculateBtn');
const info = document.getElementById('info');

let img = new Image();
let rectangles = [];
let currentRect = null;
let realWidth = 0;
const FOCAL_LENGTH = 700;

// Load image from gallery
imageInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    img.src = event.target.result;
  }
  reader.readAsDataURL(file);
});

// Draw image when loaded
img.onload = function() {
  canvas.width = img.width;
  canvas.height = img.height;
  redraw();
  realWidth = parseFloat(prompt("Enter real-world width of the object in cm:"));
  if (isNaN(realWidth) || realWidth <= 0) {
    info.innerText = "Invalid width. Reload page to try again.";
  } else {
    info.innerText = "Drag on the image to draw rectangle around the object.";
  }
}

// Convert touch/mouse coordinates to canvas coordinates
function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  let x, y;
  if (e.touches) {
    x = (e.touches[0].clientX - rect.left) * scaleX;
    y = (e.touches[0].clientY - rect.top) * scaleY;
  } else {
    x = (e.clientX - rect.left) * scaleX;
    y = (e.clientY - rect.top) * scaleY;
  }
  return {x, y};
}

// Start drawing rectangle
canvas.addEventListener('touchstart', (e) => {
  if (!img.src) return;
  const pos = getPos(e);
  currentRect = {x1: pos.x, y1: pos.y, x2: pos.x, y2: pos.y};
  e.preventDefault();
}, {passive:false});

canvas.addEventListener('touchmove', (e) => {
  if (!currentRect) return;
  const pos = getPos(e);
  currentRect.x2 = pos.x;
  currentRect.y2 = pos.y;
  redraw();
  e.preventDefault();
}, {passive:false});

canvas.addEventListener('touchend', (e) => {
  if (currentRect) {
    rectangles.push({...currentRect});
    currentRect = null;
    redraw();
  }
});

// Undo last rectangle
undoBtn.addEventListener('click', () => {
  if (rectangles.length > 0) {
    rectangles.pop();
    redraw();
  }
});

// Calculate distance
calculateBtn.addEventListener('click', () => {
  if (rectangles.length === 0 || !realWidth) {
    info.innerText = "Draw a rectangle first and enter object width.";
    return;
  }
  const rect = rectangles[rectangles.length - 1];
  const widthPx = Math.abs(rect.x2 - rect.x1);
  const distanceCm = (realWidth * FOCAL_LENGTH) / widthPx;
  const distanceMeters = distanceCm / 100;
  const distanceFeet = distanceCm / 30.48;
  info.innerText = `Distance:\n${distanceCm.toFixed(2)} cm | ${distanceMeters.toFixed(2)} m | ${distanceFeet.toFixed(2)} ft`;
});

// Redraw canvas
function redraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = 'red';
  ctx.lineWidth = 3;
  rectangles.forEach(r => {
    ctx.strokeRect(r.x1, r.y1, r.x2 - r.x1, r.y2 - r.y1);
    ctx.fillStyle = 'red';
    ctx.beginPath();
    ctx.arc(r.x1, r.y1, 5, 0, 2*Math.PI);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(r.x2, r.y2, 5, 0, 2*Math.PI);
    ctx.fill();
  });
  if (currentRect) {
    ctx.strokeStyle = 'blue';
    ctx.strokeRect(currentRect.x1, currentRect.y1, currentRect.x2 - currentRect.x1, currentRect.y2 - currentRect.y1);
  }
}
</script>

</body>
</html>
