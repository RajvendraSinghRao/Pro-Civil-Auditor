<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pro Civil Auditor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      font-size: 20px;
      margin-bottom: 15px;
    }
    input {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    button {
      flex: 1 1 48%;
      padding: 10px;
      font-size: 15px;
      cursor: pointer;
      background-color: #444;
      color: white;
      border: none;
      border-radius: 5px;
    }
    .entry, .group-total {
      font-size: 16px;
      background-color: #e6e6e6;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
    }
    .group-total {
      background-color: #c9fbc9;
      font-weight: bold;
    }
    .unit-selector {
      position: relative;
      margin-bottom: 10px;
    }
    .unit-btn {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      background-color: #222;
      color: white;
      border: none;
      border-radius: 5px;
      text-align: left;
    }
    .unit-options {
      position: absolute;
      width: 100%;
      background-color: #fff;
      max-height: 140px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 5px;
      z-index: 1;
      display: none;
    }
    .unit-options div {
      padding: 10px;
      cursor: pointer;
    }
    .unit-options div:hover {
      background-color: #eee;
    }
    .export-dropdown {
      position: relative;
      flex: 1 1 100%;
    }
    .export-dropdown-menu {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      width: 100%;
      z-index: 2;
      border-radius: 5px;
    }
    .export-dropdown-menu div {
      padding: 10px;
      cursor: pointer;
    }
    .export-dropdown-menu div:hover {
      background-color: #eee;
    }
    #deleteModal, #groupSettingsModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10;
      justify-content: center;
      align-items: center;
    }
    #deleteModalContent, #groupSettingsContent {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-height: 80%;
      overflow-y: auto;
      width: 80%;
    }
    @media (max-width: 500px) {
      button {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Pro Civil Auditor</h2>

    <input type="text" id="expressionInput" placeholder="Enter expression (e.g. 5'6 √ó 4 √ó 2 + Kitchen - 3√ó2)" />
    <input type="text" id="groupName" placeholder="Group name (optional before grouping)" />

    <div class="unit-selector">
      <button class="unit-btn" onclick="toggleUnitDropdown()">Unit: <span id="selectedUnit">sq.ft</span> ‚ñº</button>
      <div class="unit-options" id="unitDropdown">
        <div onclick="selectUnit('sq.ft')">sq.ft</div>
        <div onclick="selectUnit('sq.in')">sq.in</div>
        <div onclick="selectUnit('sq.m')">sq.m</div>
        <div onclick="selectUnit('sq.cm')">sq.cm</div>
        <div onclick="selectUnit('sq.mm')">sq.mm</div>
        <div onclick="selectUnit('normal')">Normal Math</div>
      </div>
    </div>

    <div class="buttons">
      <button onclick="evaluateExpression()">Calculate</button>
      <button onclick="resetEntries()">Reset Entry</button>
      <button onclick="groupTotal()">Group Total</button>
      <div class="export-dropdown">
        <button onclick="toggleExportDropdown()" id="exportBtn">Export ‚ñº</button>
        <div id="exportDropdown" class="export-dropdown-menu">
          <div onclick="exportToPDF()">üìÑ Export as PDF</div>
          <div onclick="exportToExcel()">üìä Export as Excel (.xlsx)</div>
        </div>
      </div>
      <button onclick="openDeleteModal()">üóëÔ∏è Delete Group(s)</button>
      <button onclick="openGroupSettings()">‚öôÔ∏è Group Settings</button>
    </div>

    <div id="entries"></div>
    <div id="groups"></div>
  </div>

  <!-- Delete Modal -->
  <div id="deleteModal">
    <div id="deleteModalContent">
      <h3>Select Groups to Delete</h3>
      <div id="deleteList"></div>
      <div style="margin-top:10px; text-align:right;">
        <button onclick="deleteSelectedGroups()">Delete Selected</button>
        <button onclick="closeDeleteModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Group Settings Modal -->
  <div id="groupSettingsModal">
    <div id="groupSettingsContent">
      <h3>Reorder Groups</h3>
      <ul id="sortableGroupList" style="list-style:none; padding:0;"></ul>
      <div style="margin-top:10px; text-align:right;">
        <button onclick="saveGroupOrder()">Save</button>
        <button onclick="closeGroupSettings()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let currentEntries = [];
    let currentTotalInches = 0;
    let entryCount = 0;
    const allGroups = [];
    let selectedUnit = 'sq.ft';

    function toggleUnitDropdown() {
      const dropdown = document.getElementById("unitDropdown");
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    }

    function selectUnit(unit) {
      selectedUnit = unit;
      document.getElementById("selectedUnit").innerText = unit;
      document.getElementById("unitDropdown").style.display = "none";
    }

    function convertFromInches(sqInches) {
      switch (selectedUnit) {
        case 'sq.ft': return (sqInches / 144).toFixed(2) + ' sq.ft';
        case 'sq.in': return sqInches.toFixed(2) + ' sq.in';
        case 'sq.m': return (sqInches * 0.00064516).toFixed(4) + ' sq.m';
        case 'sq.cm': return (sqInches * 6.4516).toFixed(2) + ' sq.cm';
        case 'sq.mm': return (sqInches * 645.16).toFixed(1) + ' sq.mm';
        case 'normal': return sqInches.toFixed(2);
      }
    }

    function replaceDimensions(expr) {
      expr = expr.replace(/(\d+)'(\d+)/g, (_, ft, inch) => `(${parseInt(ft) * 12 + parseInt(inch)})`);
      expr = expr.replace(/(\d+(\.\d+)?)'/g, (_, num) => `(${parseFloat(num) * 12})`);
      expr = expr.replace(/'(\d+(\.\d+)?)/g, (_, num) => `(${parseFloat(num)})`);
      expr = expr.replace(/[√óxX]/g, '*').replace(/[√∑/]/g, '/');
      return expr;
    }

    function replaceGroupNames(expr) {
      allGroups.forEach(group => {
        const pattern = new RegExp(`\\b${group.name}\\b`, 'gi');
        expr = expr.replace(pattern, `(${group.totalInches})`);
      });
      return expr;
    }

    function evaluateExpression() {
      const input = document.getElementById("expressionInput").value.trim();
      if (!input) return;
      let parsed = input, result = 0;

      if (selectedUnit === 'normal') {
        parsed = replaceGroupNames(parsed);
        try { result = eval(parsed); } catch { alert("‚ùå Invalid expression."); return; }
      } else if (['sq.m', 'sq.cm', 'sq.mm'].includes(selectedUnit)) {
        parsed = replaceGroupNames(parsed).replace(/[√óxX]/g, '*').replace(/[√∑/]/g, '/');
        try { result = eval(parsed); } catch { alert("‚ùå Invalid expression."); return; }
        if (selectedUnit === 'sq.m') result *= 1550.0031;
        if (selectedUnit === 'sq.cm') result *= 0.15500031;
        if (selectedUnit === 'sq.mm') result *= 0.00155;
      } else {
        parsed = replaceDimensions(input);
        parsed = replaceGroupNames(parsed);
        try { result = eval(parsed); } catch { alert("‚ùå Invalid expression."); return; }
      }

      entryCount++;
      const resultText = convertFromInches(result);
      const entryText = `#${entryCount}) ${input} = ${resultText}`;
      currentEntries.push(entryText);
      if (selectedUnit !== 'normal') currentTotalInches += result;

      const entryDiv = document.createElement("div");
      entryDiv.className = "entry";
      entryDiv.innerText = entryText;
      document.getElementById("entries").appendChild(entryDiv);
      document.getElementById("expressionInput").value = "";
    }

    function resetEntries() {
      currentEntries = [];
      currentTotalInches = 0;
      entryCount = 0;
      document.getElementById("entries").innerHTML = "";
    }

    function groupTotal() {
      const groupName = document.getElementById("groupName").value.trim() || `Group ${allGroups.length + 1}`;
      const group = { name: groupName, entries: [...currentEntries], totalInches: currentTotalInches };
      allGroups.push(group);
      saveGroupsToStorage();
      renderGroups();
      resetEntries();
      document.getElementById("groupName").value = "";
    }

    function renderGroups() {
      const groupsDiv = document.getElementById("groups");
      groupsDiv.innerHTML = "";
      allGroups.forEach((group, index) => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "group-total";
        let html = `üì¶ <strong contenteditable="true" onblur="renameGroup(${index}, this.innerText.trim())">${group.name}</strong><br>`;
        group.entries.forEach((entry, entryIndex) => {
          html += `<div contenteditable="true" onblur="updateEntry(${index}, ${entryIndex}, this.innerText)">${entry}</div>`;
        });
        if (group.entries.length > 0)
          html += `üßÆ <strong>Total = ${convertFromInches(group.totalInches)}</strong>`;
        groupDiv.innerHTML = html;
        groupsDiv.appendChild(groupDiv);
      });
    }

    function renameGroup(index, newName) {
      if (newName !== "") {
        allGroups[index].name = newName;
        saveGroupsToStorage();
      }
    }

    function updateEntry(groupIndex, entryIndex, newText) {
      allGroups[groupIndex].entries[entryIndex] = newText;
      const values = allGroups[groupIndex].entries.map(text => {
        const match = text.match(/=\s*(\d+(\.\d+)?)/);
        return match ? parseFloat(match[1]) : 0;
      });
      allGroups[groupIndex].totalInches = values.reduce((sum, val) => sum + val, 0);
      saveGroupsToStorage();
      renderGroups();
    }

    function toggleExportDropdown() {
      document.getElementById("exportDropdown").style.display = document.getElementById("exportDropdown").style.display === "block" ? "none" : "block";
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF(); let y = 20;
      doc.setFontSize(16); doc.text("Pro Civil Auditor", 20, y); y += 10;
      allGroups.forEach(group => {
        doc.setFontSize(14); doc.text(`${group.name}`, 20, y); y += 10;
        group.entries.forEach(entry => { doc.setFontSize(12); doc.text(`- ${entry}`, 25, y); y += 8; if (y > 270) { doc.addPage(); y = 20; } });
        if (group.entries.length > 0) { doc.setFontSize(13); doc.text(`= Total: ${convertFromInches(group.totalInches)}`, 25, y); y += 12; } else { y += 5; }
        if (y > 270) { doc.addPage(); y = 20; }
      });
      doc.save("Pro Civil Auditor.pdf");
    }

    function exportToExcel() {
      if (allGroups.length === 0) return alert("‚ö†Ô∏è No group data to export.");
      const wb = XLSX.utils.book_new(); const data = [];
      allGroups.forEach(group => {
        data.push([`${group.name}`]);
        group.entries.forEach(entry => data.push([entry]));
        if (group.entries.length > 0) data.push([`Total = ${convertFromInches(group.totalInches)}`]);
        data.push(['']);
      });
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "All Groups");
      XLSX.writeFile(wb, "Pro Civil Auditor.xlsx");
    }

    function openDeleteModal() {
      const listContainer = document.getElementById("deleteList");
      listContainer.innerHTML = "";
      allGroups.forEach((group, index) => {
        const div = document.createElement("div");
        div.innerHTML = `<label style="display:flex;align-items:center;gap:10px;"><input type="checkbox" value="${index}" /> ${group.name}</label>`;
        listContainer.appendChild(div);
      });
      document.getElementById("deleteModal").style.display = "flex";
    }

    function closeDeleteModal() {
      document.getElementById("deleteModal").style.display = "none";
    }

    function deleteSelectedGroups() {
      const checkboxes = document.querySelectorAll("#deleteList input[type='checkbox']:checked");
      const indexesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
      indexesToDelete.forEach(index => allGroups.splice(index, 1));
      saveGroupsToStorage();
      renderGroups();
      closeDeleteModal();
    }

    function openGroupSettings() {
      const list = document.getElementById("sortableGroupList");
      list.innerHTML = "";
      allGroups.forEach((group, index) => {
        const li = document.createElement("li");
        li.draggable = true;
        li.dataset.index = index;
        li.style.padding = "10px";
        li.style.border = "1px solid #ccc";
        li.style.marginBottom = "5px";
        li.style.background = "#f9f9f9";
        li.style.cursor = "move";
        li.innerText = group.name;

        li.addEventListener("dragstart", e => {
          e.dataTransfer.setData("text/plain", index);
          li.style.opacity = "0.5";
        });

        li.addEventListener("dragover", e => e.preventDefault());

        li.addEventListener("drop", e => {
          e.preventDefault();
          const from = parseInt(e.dataTransfer.getData("text/plain"));
          const to = parseInt(li.dataset.index);
          const moved = allGroups.splice(from, 1)[0];
          allGroups.splice(to, 0, moved);
          openGroupSettings();
        });

        li.addEventListener("dragend", () => {
          li.style.opacity = "1";
        });

        list.appendChild(li);
      });
      document.getElementById("groupSettingsModal").style.display = "flex";
    }

    function saveGroupOrder() {
      saveGroupsToStorage();
      renderGroups();
      closeGroupSettings();
    }

    function closeGroupSettings() {
      document.getElementById("groupSettingsModal").style.display = "none";
    }

    function saveGroupsToStorage() {
      localStorage.setItem("civilGroups", JSON.stringify(allGroups));
    }

    window.onload = function () {
      const saved = localStorage.getItem("civilGroups");
      if (saved) {
        const parsed = JSON.parse(saved);
        parsed.forEach(g => allGroups.push(g));
        renderGroups();
      }
    };

    window.onclick = function (event) {
      if (!event.target.closest('#exportBtn')) document.getElementById("exportDropdown").style.display = "none";
      if (!event.target.matches('.unit-btn')) document.getElementById("unitDropdown").style.display = "none";
    };
  </script>
</body>
</html>
